{% extends 'base.html' %}
{% block content %}
<div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
  <div>
    <h2 class="mb-1">Управление пользователями</h2>
    <p class="text-secondary mb-0">Назначайте роли и поддерживайте актуальный список сотрудников системы.</p>
  </div>
  <a class="btn btn-outline-light" href="{{ url_for('dashboard.index') }}">К дашборду</a>
</div>

<div class="card bg-dark border-secondary">
  <div class="table-responsive">
    <table class="table table-dark table-hover align-middle mb-0">
      <thead class="text-secondary small text-uppercase">
        <tr>
          <th scope="col">Пользователь</th>
          <th scope="col">Email</th>
          <th scope="col">Роль</th>
          <th scope="col" class="text-end">Статус</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        {% set user_role_name = normalize_role(user) %}
        {% set form_id = 'user-form-' ~ user.id %}
        <tr>
          <td>
            <div class="fw-semibold mb-1">
              <input
                class="form-control form-control-sm"
                type="text"
                name="full_name"
                value="{{ user.full_name or '' }}"
                placeholder="Введите ФИО"
                form="{{ form_id }}"
              >
            </div>
          </td>
          <td>{{ user.email }}</td>
          <td>
            <form id="{{ form_id }}" method="post" action="{{ url_for('users.update_role', user_id=user.id) }}" class="d-flex flex-column flex-lg-row gap-2 align-items-lg-center">
              <div class="d-flex gap-2 align-items-center">
                <select class="form-select form-select-sm" name="role_id">
                  {% set selected_role = normalize_role(user) %}
                  {% for role in roles %}
                    <option value="{{ role.id }}" {% if selected_role == role.name %}selected{% endif %}>
                      {{ role_descriptions.get(role.name, role.name) }}
                    </option>
                  {% endfor %}
                </select>
                <button class="btn btn-sm btn-accent px-3" type="submit">Сохранить</button>
              </div>
              <div class="text-secondary small">
                {{ role_descriptions.get(user_role_name, 'Роль не назначена') }}
              </div>
            </form>
          </td>
          <td class="text-end">
            {% if user == current_user %}
              <span class="badge text-bg-secondary">Это вы</span>
            {% elif user.is_active %}
              <span class="badge text-bg-success">Активен</span>
            {% else %}
              <span class="badge text-bg-secondary">Не активен</span>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="4" class="text-center text-secondary py-5">
            Пользователи не найдены.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

