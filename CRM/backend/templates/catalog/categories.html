{% extends 'base.html' %}
{% block content %}
<div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
  <div>
    <h2 class="mb-1">Категории блюд</h2>
    <p class="text-secondary mb-0">Группируйте блюда по разделам меню. Родительские категории помогают строить древовидную структуру.</p>
  </div>
  <a class="btn btn-outline-light" href="{{ url_for('catalog.list_products') }}">Назад к каталогу</a>
</div>

<div class="row g-4">
  <div class="col-lg-5">
    <div class="card bg-dark border-secondary h-100">
      <div class="card-header border-secondary">
        <h6 class="mb-0">Добавить категорию</h6>
      </div>
      <div class="card-body">
        <form method="post" action="{{ url_for('catalog.manage_categories') }}" class="vstack gap-3">
          <div>
            <label class="form-label small text-uppercase text-secondary">Название</label>
            <input
              class="form-control"
              name="name"
              value="{{ form_state.get('name', '') }}"
              placeholder="Например, Горячие блюда"
              required
            >
          </div>
          <div>
            <label class="form-label small text-uppercase text-secondary">Родительская категория</label>
            <select class="form-select" name="parent_id">
              <option value="">Без родителя</option>
              {% for category in categories %}
                <option value="{{ category.id }}" {% if form_state.get('parent_id') == category.id|string %}selected{% endif %}>
                  {{ category.name }}
                </option>
              {% endfor %}
            </select>
            <div class="form-text text-secondary">
              Можно вложить категорию в другую, чтобы сгруппировать ассортимент.
            </div>
          </div>
          <div class="d-flex justify-content-end">
            <button class="btn btn-accent px-4">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-7">
    <div class="card bg-dark border-secondary h-100">
      <div class="card-header border-secondary d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Список категорий</h6>
        <span class="text-secondary small">Всего: {{ categories|length }}</span>
      </div>
      <div class="card-body p-0">
        {% if categories %}
          <div class="table-responsive">
            <table class="table table-dark align-middle table-hover mb-0">
              <thead class="text-secondary small text-uppercase">
                <tr>
                  <th scope="col">Название</th>
                  <th scope="col">Родитель</th>
                  <th scope="col">Блюд</th>
                  <th scope="col" class="text-end">Действия</th>
                </tr>
              </thead>
              <tbody>
                {% for category in categories %}
                  <tr>
                    <td class="fw-semibold">{{ category.name }}</td>
                    <td>
                      {% if category.parent %}
                        {{ category.parent.name }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td>{{ product_counts.get(category.id, 0) }}</td>
                    <td class="text-end">
                      <form method="post" action="{{ url_for('catalog.delete_category', category_id=category.id) }}" class="d-inline">
                        <button
                          class="btn btn-sm btn-outline-danger"
                          type="submit"
                          {% if product_counts.get(category.id, 0) > 0 or category.children %}
                            disabled
                          {% endif %}
                          onclick="return confirm('Удалить категорию «{{ category.name }}»?');"
                        >
                          Удалить
                        </button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="p-4 text-center text-secondary">
            Категории ещё не созданы. Добавьте первую с помощью формы слева.
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

